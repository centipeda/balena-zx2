# meta-balena-zynq

The BalenaOS guidelines for supporting hardware other than [those that Balena releases builds for](https://www.balena.io/os/docs/supported-boards/) involve creating a "`meta-balena-<board-family>`" Yocto layer. The structure looks like this (taken from the documentation):
```
├── COPYING.Apache-2.0
├── README.md
├── conf
│   ├── layer.conf
│   └── samples
│       ├── bblayers.conf.sample
│       ├── conf-notes.txt
│       └── local.conf.sample
├── recipes-bsp
│   ├── u-boot_%.bbappend
│   └── u-boot-xlnx_%.bbappend
├── recipes-containers
│   └── docker-disk
│       └── docker-balena-supervisor-disk.bbappend
├── recipes-core
│   └── images
│       └── resin-image.bbappend
└── recipes-kernel
    └── linux
        ├── linux-<board-family>-<version>
        │   └── <patch files>
        ├── linux-<board-family>_%.bbappend
        └── linux-<board>_<version>.bbappend
```

#### layer.conf

The main configuration file for the layer. Sets the Yocto versions it's compatible with (at this point, the only one that's compatible with both meta-xilinx and meta-balena is warrior.)

#### samples/*

Other configuration files which are stored as samples. When a build is started with BARYS, these files will be put into the `build/` directory at the top level of this repository as their respective configuration files.

##### conf-notes.txt

This file is autogenerated by BARYS (I believe). It displays "balenaOS" in large text when BARYS begins its build, and when Poky is started up by sourcing `oe-init-build-env`.

##### bblayers.conf.sample

Lists all the layers that are to be included in the build. If a layer directory needs to be added, it has to be added to this file.

##### local.conf.sample

Defines some other build variables, like which `$MACHINE`s are supported, and other distro features required by balenaOS, like systemd.

#### recipes-bsp/u-boot*_%.bbappend

This recipe should be appended to the U-Boot recipe, and *should* apply the patches that U-Boot requires for Balena to boot with it ([possible root issue here](https://forums.balena.io/t/kernel-panic-not-syncing-attempted-to-kill-init/19932/21)).

I'm not sure *exactly* which package is the one needed, so there are both `u-boot-xlnx_%.bbappend` and `u-boot_%.bbappend` files. I don't think this causes any issues, but it should probably be figured out eventually.

#### recipes-containers/docker-disk/docker-balena-supervisor-disk.bbappend

This is used by Balena in some way (I'm not clear exactly what). It defines the system path for an onboard status LED, which is a path something like `/sys/class/.../led/`. I need to determine exactly what the LED path is for the Mars PM3.

#### recipes-core/images/resin-image.bbappend

Note that in the Balena documentation, this file is called `balena-image.bbappend`, but since the Yocto package balenaOS produces is still called `resin-image`, this has to be named `resin-image.bbappend`.

This defines the files that should be on the boot partition of the image when it installs, as well as whether the resulting image should be deployed to an SD card or internal storage.